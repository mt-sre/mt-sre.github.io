<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.117.0"><link rel=canonical type=text/html href=/docs/internal-documentation/tutorials/><link rel=alternate type=application/rss+xml href=/docs/internal-documentation/tutorials/index.xml><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/favicons/android-chrome-512x512.png sizes=512x512><title>Tutorials | Layered Products SRE</title><meta name=description content><meta property="og:title" content="Tutorials"><meta property="og:description" content="Documentation for Layered Products SRE at Red Hat"><meta property="og:type" content="website"><meta property="og:url" content="/docs/internal-documentation/tutorials/"><meta itemprop=name content="Tutorials"><meta itemprop=description content="Documentation for Layered Products SRE at Red Hat"><meta name=twitter:card content="summary"><meta name=twitter:title content="Tutorials"><meta name=twitter:description content="Documentation for Layered Products SRE at Red Hat"><link rel=preload href=/scss/main.min.0799d219d5950ac36000bb078e915525f0e42b82cd2a4e21fbeb9a6015fc5ef0.css as=style><link href=/scss/main.min.0799d219d5950ac36000bb078e915525f0e42b82cd2a4e21fbeb9a6015fc5ef0.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo></span><span class=font-weight-bold>Layered Products SRE</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/internal-documentation/access/><span>Getting Access</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.faf0887fa1f0e40829c82c53f22dc327.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/internal-documentation/tutorials/>Return to the regular view of this page</a>.</p></div><h1 class=title>Tutorials</h1><ul><li>1: <a href=#pg-dd2dea1c47a6d323996052290d100a90>Adding ADO alerts</a></li><li>2: <a href=#pg-5da6968793d1f802cd0b0096fd75b798>Run Hive Locally</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-dd2dea1c47a6d323996052290d100a90>1 - Adding ADO alerts</h1><p>This guide describes how to add alerts for addon-operator in the OSD RHOBS tenant.</p><h2 id=background>Background</h2><p>Since the addon-operator doesn’t have a specific tenant in RHOBS with a service account,
the addon-operator metrics are scraped to the OSD tenant with its own service account,
so instead of adding rules using <a href=https://github.com/observatorium/obsctl>obsctl cli</a> and
syncing them using <a href=https://github.com/rhobs/obsctl-reloader>obsctl-reloader</a>
SRE-P has a repo called <a href=https://gitlab.cee.redhat.com/service/rhobs-rules-and-dashboards>rhobs-rules-and-dashboards</a>
which, based on the tenant, will automatically sync rules defined in the repo to app-interface.</p><h2 id=overview>Overview</h2><p>We need to have the following prerequisites:</p><p>If the tenant is not defined in the repo, we need to follow the process defined
<a href=https://gitlab.cee.redhat.com/service/rhobs-rules-and-dashboards/-/tree/main/rules#registering-a-new-tenant>here</a>
which explains how to register the tenant in app-interface and how to configure obsctl-reloader
to sync rules for the particular tenant.</p><p>The OSD tenant is already registered and the obsctl-reloader configuration is already
defined <a href=https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/data/services/rhobs/observatorium-mst/cicd/saas.yaml#L127>here</a>
(we should see osd in <strong>MANAGED_TENANTS</strong> parameter in the <strong>observatorium-mst-common</strong> named
item and secrets are defined <a href=https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/data/services/rhobs/observatorium-mst/namespaces/app-sre-stage-01/observatorium-mst-stage.yml#L79>here</a>)</p><h2 id=steps>Steps</h2><p>we can define rules for the addon-operator metrics in the <a href=https://gitlab.cee.redhat.com/service/rhobs-rules-and-dashboards>rhobs-rules-and-dashboards</a>
repo in the <a href=https://gitlab.cee.redhat.com/service/rhobs-rules-and-dashboards/-/tree/main/rules/osd>rules/osd</a>
folder (the tenants are added as individual folders) and tests for the prometheus rules are
defined in the <a href=https://gitlab.cee.redhat.com/service/rhobs-rules-and-dashboards/-/tree/main/test/rules/osd>tests/rules/osd</a>
folder.
The suggested file naming conventions are described <a href=https://gitlab.cee.redhat.com/service/rhobs-rules-and-dashboards/-/tree/main/rules#one-folder-per-targeted-rhobs-tenant>here</a>.</p><p>tldr: create file name with <code>.prometheusrule.yaml</code> as a suffix,
add tenant label to the <code>PrometheusRule</code> object.</p><h3 id=adding-promrules>Adding promrules</h3><p>For creating a PoC alert we have selected the <code>addon_operator_addon_health_info</code> metric
since it basically explains the addon health for a particular <code>version</code> and <code>cluster_id</code>.
The metrics for creating alerts can be decided and the promql queries
can be tested out from <a href=https://promlens.stage.devshift.net>promlens stage</a>
or <a href=https://promlens.devshift.net>promlens prod</a>.
The metrics are scraped from addon-operator to the
observatorium-mst-stage (stage) / observatorium-mst-prod (prod) datasources.</p><p>Sample <code>addon_operator_addon_health_info</code> metric data:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>addon_operator_addon_health_info{_id=&#34;08d94ae0-a943-47ea-ac29-6cf65284aeba&#34;, container=&#34;metrics-relay-server&#34;, endpoint=&#34;https&#34;, instance=&#34;10.129.2.11:8443&#34;, job=&#34;addon-operator-metrics&#34;, name=&#34;managed-odh&#34;, namespace=&#34;openshift-addon-operator&#34;, pod=&#34;addon-operator-manager-7c9df45684-86mh4&#34;, prometheus=&#34;openshift-monitoring/k8s&#34;, receive=&#34;true&#34;, service=&#34;addon-operator-metrics&#34;, tenant_id=&#34;770c1124-6ae8-4324-a9d4-9ce08590094b&#34;, version=&#34;0.0.0&#34;}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This particular metric gives information about
<code>version</code>, <code>cluster_id (_id)</code> and <code>addon_name (name)</code> which can be used to create the alert.</p><ul><li>We should ignore the metrics with version <code>"0.0.0"</code></li><li>The addon health is <code>"Unhealthy"</code> if no version exists for the particular
addon with <a href=https://github.com/openshift/addon-operator#monitoring-and-metrics>value 1</a></li><li>In theory, the latest version for the particular addon
should have the value of 1. If not, then the addon is <code>"Unhealthy"</code></li></ul><p>The prometheus rule for the addon_operator_addon_health_info metric is defined <a href=https://gitlab.cee.redhat.com/service/rhobs-rules-and-dashboards/-/blob/main/rules/osd/addon-operator-addon-health-info-rules.prometheusrule.yaml>here</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>expr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>(count by (name, _id) (addon_operator_addon_health_info{version!=&#34;0.0.0&#34;})) - (count by (name,_id) (addon_operator_addon_health_info{version!=&#34;0.0.0&#34;} == 0)) == 0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Explanation:</p><p>We aggregate all metrics on <code>name</code> and <code>_id</code> and count the non-0 value metrics.
If the count is 0 (implying there has been no non-0 value metrics), raise the alert.</p><h3 id=writing-tests-for-the-promrules>Writing tests for the promrules</h3><p>First create a <code>&lt;alertname>.promrulestests.yaml</code> file in the test/rules/<tenant>/ folder,
It is advised to test out different scenarios for the edge cases so
that the expr defined in the rules/<tenant> folder will raise alert if say the addon is <code>"Unhealthy"</code>.
Try out different scenarios by defining different series as
input to the test rules such as <a href=https://gitlab.cee.redhat.com/service/rhobs-rules-and-dashboards/-/blob/main/test/rules/osd/addon-operator-addon-health-info-rules.prometheusrulestests.yaml#L8>here</a>.</p><p>The tests can be validated by running: <code>make test-rules</code>
in the rhobs-rules-and-dashboards directory.
NOTE: Make sure that the tests are defined in the tests/rules/<tenant> folder</p><p>Since the pagerduty config is defined on a per tenant basis which is <code>osd tenant</code> in this case,
the alert will be triggered and paged to SRE-P,
so a proper runbook should be added redirecting the alert to lp-sre folks.</p><p>The runbook links/ SOP links can be validated by running: <code>make check-runbooks</code></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5da6968793d1f802cd0b0096fd75b798>2 - Run Hive Locally</h1><p>This guide describes how to deploy a Hive environment in your local machine
using <a href=https://kind.sigs.k8s.io/>kind</a>.</p><p>For the managed clusters, this guide covers both
<a href=https://kind.sigs.k8s.io/>kind</a> clusters and
<a href=https://developers.redhat.com/products/codeready-containers/overview>CRC</a>
clusters.</p><h2 id=preparation>Preparation</h2><p>Setup your <code>GOPATH</code>. Add to your <code>~/.bashrc</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GOPATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$HOME</span>/go
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>PATH</span><span style=color:#4e9a06>}</span>:<span style=color:#4e9a06>${</span><span style=color:#000>GOPATH</span><span style=color:#4e9a06>}</span>/bin
</span></span></code></pre></div><p>Install <code>kind</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.10.0/kind-linux-amd64
</span></span><span style=display:flex><span>~$ chmod +x ./kind
</span></span><span style=display:flex><span>~$ mv ./kind ~/.local/bin/kind
</span></span></code></pre></div><blockquote><p>This guide was created using kind version: <code>kind v0.14.0 go1.18.2 linux/amd64</code></p></blockquote><p>Install the dependencies:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ <span style=color:#000>GO111MODULE</span><span style=color:#ce5c00;font-weight:700>=</span>on go get sigs.k8s.io/kustomize/kustomize/v3
</span></span><span style=display:flex><span>~$ go get github.com/cloudflare/cfssl/cmd/cfssl
</span></span><span style=display:flex><span>~$ go get github.com/cloudflare/cfssl/cmd/cfssljson
</span></span><span style=display:flex><span>~$ go get -u github.com/openshift/imagebuilder/cmd/imagebuilder
</span></span></code></pre></div><p>Clone OLM and checkout the version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ git clone git@github.com:operator-framework/operator-lifecycle-manager.git
</span></span><span style=display:flex><span>~$ <span style=color:#204a87>cd</span> operator-lifecycle-manager
</span></span><span style=display:flex><span>~/operator-lifecycle-manager$ git checkout -b v0.21.2 v0.21.2
</span></span><span style=display:flex><span>~/operator-lifecycle-manager$ <span style=color:#204a87>cd</span> ..
</span></span></code></pre></div><p>Clone Hive and checkout the version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ git clone git@github.com:openshift/hive.git
</span></span><span style=display:flex><span>~$ <span style=color:#204a87>cd</span> hive
</span></span><span style=display:flex><span>~/hive$ git checkout 56adaaacf5f8075e3ad0896dac35243a863ec07b
</span></span></code></pre></div><p>Edit the <code>hack/create-kind-cluster.sh</code>, adding the apiServerAddress pointing
to your local <code>docker0</code> bridge IP. This is needed so the Hive cluster, which
runs inside a docker container, can reach the managed cluster, running inside
another docker container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kind.x-k8s.io/v1alpha4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>networking</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>apiServerAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;172.17.0.1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># docker0 bridge IP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>containerdConfigPatches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000;font-weight:700>|-</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.mirrors.&#34;localhost:${reg_port}&#34;]
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      endpoint = [&#34;http://${reg_name}:${reg_port}&#34;]</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div><h2 id=hive>Hive</h2><p>Export the Hive kubeconfig filename (it will be created later):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ <span style=color:#204a87>export</span> <span style=color:#000>KUBECONFIG</span><span style=color:#ce5c00;font-weight:700>=</span>/tmp/hive.conf
</span></span></code></pre></div><p>Enter the <code>hive</code> directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ <span style=color:#204a87>cd</span> hive
</span></span></code></pre></div><p>Create the Hive cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ ./hack/create-kind-cluster.sh hive
</span></span><span style=display:flex><span>Creating cluster <span style=color:#4e9a06>&#34;hive&#34;</span> ...
</span></span><span style=display:flex><span>Creating cluster <span style=color:#4e9a06>&#34;hive&#34;</span> ...
</span></span><span style=display:flex><span> ✓ Ensuring node image <span style=color:#ce5c00;font-weight:700>(</span>kindest/node:v1.24.0<span style=color:#ce5c00;font-weight:700>)</span> 🖼
</span></span><span style=display:flex><span> ✓ Preparing nodes 📦
</span></span><span style=display:flex><span> ✓ Writing configuration 📜
</span></span><span style=display:flex><span> ✓ Starting control-plane 🕹️
</span></span><span style=display:flex><span> ✓ Installing CNI 🔌
</span></span><span style=display:flex><span> ✓ Installing StorageClass 💾
</span></span><span style=display:flex><span>Set kubectl context to <span style=color:#4e9a06>&#34;kind-hive&#34;</span>
</span></span><span style=display:flex><span>You can now use your cluster with:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl cluster-info --context kind-hive
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Not sure what to <span style=color:#204a87;font-weight:700>do</span> next? 😅  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
</span></span></code></pre></div><p>The <code>/tmp/hive.conf</code> file is created now. Checking the installation:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ docker ps
</span></span><span style=display:flex><span>CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS         PORTS                                       NAMES
</span></span><span style=display:flex><span>901f215229a4   kindest/node:v1.24.0   <span style=color:#4e9a06>&#34;/usr/local/bin/entr…&#34;</span>   <span style=color:#0000cf;font-weight:700>2</span> minutes ago   Up <span style=color:#0000cf;font-weight:700>2</span> minutes   172.17.0.1:41299-&gt;6443/tcp                  hive-control-plane
</span></span><span style=display:flex><span>0d4bf61da0a3   registry:2             <span style=color:#4e9a06>&#34;/entrypoint.sh /etc…&#34;</span>   <span style=color:#0000cf;font-weight:700>3</span> hours ago     Up <span style=color:#0000cf;font-weight:700>3</span> hours     0.0.0.0:5000-&gt;5000/tcp, :::5000-&gt;5000/tcp   kind-registry
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$  kubectl cluster-info
</span></span><span style=display:flex><span>Kubernetes control plane is running at https://172.17.0.1:41299
</span></span><span style=display:flex><span>KubeDNS is running at https://172.17.0.1:41299/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>To further debug and diagnose cluster problems, use <span style=color:#4e9a06>&#39;kubectl cluster-info dump&#39;</span>.
</span></span></code></pre></div><p>Build Hive and push the image to the local registry:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ <span style=color:#000>CGO_ENABLED</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000>IMG</span><span style=color:#ce5c00;font-weight:700>=</span>localhost:5000/hive:latest make docker-dev-push
</span></span></code></pre></div><p>Deploy Hive to the hive cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ <span style=color:#000>IMG</span><span style=color:#ce5c00;font-weight:700>=</span>localhost:5000/hive:latest make deploy
</span></span></code></pre></div><p>Because we are not running on OpenShift we must also create a secret with
certificates for the hiveadmission webhooks:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ ./hack/hiveadmission-dev-cert.sh
</span></span></code></pre></div><p>If the hive cluster is using node image <code>kindest/node:v1.24.0</code> or later, you will
have to additionally run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ ./hack/create-service-account-secrets.sh
</span></span></code></pre></div><p>because starting in Kubernetes 1.24.0, secrets are no longer automatically generated
for service accounts.</p><p>Tip: if it fails, check <code>kubectl</code> version. The <code>Client</code> and <code>Server</code> versions
should be in sync:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ kubectl version --short
</span></span><span style=display:flex><span>Client Version: v1.24.0
</span></span><span style=display:flex><span>Kustomize Version: v4.5.4
</span></span><span style=display:flex><span>Server Version: v1.24.0
</span></span></code></pre></div><p>Checking the Hive pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ kubectl get pods -n hive
</span></span><span style=display:flex><span>NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>hive-clustersync-0                  1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          26m
</span></span><span style=display:flex><span>hive-controllers-79bbbc7f98-q9pxm   1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          26m
</span></span><span style=display:flex><span>hive-operator-69c4649b96-wmd79      1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          26m
</span></span><span style=display:flex><span>hiveadmission-6697d9df99-jdl4l      1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          26m
</span></span><span style=display:flex><span>hiveadmission-6697d9df99-s9pv9      1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          26m
</span></span></code></pre></div><h2 id=managed-cluster---kind>Managed Cluster - Kind</h2><p>Open a new terminal.</p><p>Export the Hive kubeconfig filename (it will be created later):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ <span style=color:#204a87>export</span> <span style=color:#000>KUBECONFIG</span><span style=color:#ce5c00;font-weight:700>=</span>/tmp/cluster1.conf
</span></span></code></pre></div><p>Enter the <code>hive</code> directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ <span style=color:#204a87>cd</span> hive
</span></span><span style=display:flex><span>~/hive$
</span></span></code></pre></div><p>Create the managed cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ ./hack/create-kind-cluster.sh cluster1
</span></span><span style=display:flex><span>Creating cluster <span style=color:#4e9a06>&#34;cluster1&#34;</span> ...
</span></span><span style=display:flex><span> ✓ Ensuring node image <span style=color:#ce5c00;font-weight:700>(</span>kindest/node:v1.24.0<span style=color:#ce5c00;font-weight:700>)</span> 🖼
</span></span><span style=display:flex><span> ✓ Preparing nodes 📦
</span></span><span style=display:flex><span> ✓ Writing configuration 📜
</span></span><span style=display:flex><span> ✓ Starting control-plane 🕹️
</span></span><span style=display:flex><span> ✓ Installing CNI 🔌
</span></span><span style=display:flex><span> ✓ Installing StorageClass 💾
</span></span><span style=display:flex><span>Set kubectl context to <span style=color:#4e9a06>&#34;kind-cluster1&#34;</span>
</span></span><span style=display:flex><span>You can now use your cluster with:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl cluster-info --context kind-cluster1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Have a nice day! 👋
</span></span><span style=display:flex><span> 😊
</span></span></code></pre></div><p>The <code>/tmp/cluster1.conf</code> file is created now. Checking the installation:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ docker ps
</span></span><span style=display:flex><span>CONTAINER ID   IMAGE                  COMMAND                  CREATED             STATUS             PORTS                                       NAMES
</span></span><span style=display:flex><span>267fa20f4a0f   kindest/node:v1.24.0   <span style=color:#4e9a06>&#34;/usr/local/bin/entr…&#34;</span>   <span style=color:#0000cf;font-weight:700>2</span> minutes ago       Up <span style=color:#0000cf;font-weight:700>2</span> minutes       172.17.0.1:40431-&gt;6443/tcp                  cluster1-control-plane
</span></span><span style=display:flex><span>901f215229a4   kindest/node:v1.24.0   <span style=color:#4e9a06>&#34;/usr/local/bin/entr…&#34;</span>   About an hour ago   Up About an hour   172.17.0.1:41299-&gt;6443/tcp                  hive-control-plane
</span></span><span style=display:flex><span>0d4bf61da0a3   registry:2             <span style=color:#4e9a06>&#34;/entrypoint.sh /etc…&#34;</span>   <span style=color:#0000cf;font-weight:700>5</span> hours ago         Up <span style=color:#0000cf;font-weight:700>5</span> hours         0.0.0.0:5000-&gt;5000/tcp, :::5000-&gt;5000/tcp   kind-registry
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ kubectl cluster-info
</span></span><span style=display:flex><span>Kubernetes control plane is running at https://172.17.0.1:40431
</span></span><span style=display:flex><span>KubeDNS is running at https://172.17.0.1:40431/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>To further debug and diagnose cluster problems, use <span style=color:#4e9a06>&#39;kubectl cluster-info dump&#39;</span>.
</span></span></code></pre></div><p>Before we install OLM, we have to edit the install scripts to use <code>cluster1</code>. Go into <code>scripts/build_local.sh</code>
and replace</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[[</span> <span style=color:#4e9a06>${#</span><span style=color:#000>CLUSTERS</span><span style=color:#000;font-weight:700>[@]</span><span style=color:#4e9a06>}</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#000>KIND_FLAGS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;--name </span><span style=color:#4e9a06>${</span><span style=color:#000>CLUSTERS</span><span style=color:#000;font-weight:700>[0]</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#39;Use cluster ${CLUSTERS[0]}&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>fi</span>
</span></span></code></pre></div><p>with</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#000>KIND_FLAGS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;--name cluster1&#34;</span>
</span></span></code></pre></div><p>Now enter the OLM directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ <span style=color:#204a87>cd</span> ../operator-lifecycle-manager/
</span></span><span style=display:flex><span>~/operator-lifecycle-manager$
</span></span></code></pre></div><p>Install the CRDs and OLM using:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/operator-lifecycle-manager$ make run-local
</span></span></code></pre></div><p>OLM pods should be running now:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/git/operator-lifecycle-manager$ kubectl get pods -n olm
</span></span><span style=display:flex><span>NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>catalog-operator-54bbdffc6b-hf8rz   1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          87s
</span></span><span style=display:flex><span>olm-operator-6bfbd74fb8-cjl4b       1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          87s
</span></span><span style=display:flex><span>operatorhubio-catalog-gdk2d         1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          48s
</span></span><span style=display:flex><span>packageserver-5d67bbc56b-6vxqb      1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          46s
</span></span></code></pre></div><p>With the cluster1 installed, let&rsquo;s create a <code>ClusterDeployment</code> in Hive
pointing to it.</p><p>Export the Hive kubeconfig filename and enter the <code>hive</code> directory (or just
switch to the first terminal, the one used to deploy Hive):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ <span style=color:#204a87>export</span> <span style=color:#000>KUBECONFIG</span><span style=color:#ce5c00;font-weight:700>=</span>/tmp/hive.conf
</span></span><span style=display:flex><span>~$ <span style=color:#204a87>cd</span> hive
</span></span></code></pre></div><p>Attention: hiveutil wants you to have default credentials in ~/.aws/credentials
You can fake them like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ cat ~/.aws/credentials
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>default<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000>aws_access_key_id</span> <span style=color:#ce5c00;font-weight:700>=</span> foo
</span></span><span style=display:flex><span><span style=color:#000>aws_secret_access_key</span> <span style=color:#ce5c00;font-weight:700>=</span> bar
</span></span></code></pre></div><p>Because Hive will not provision that cluster, we have can use the <code>hiveutil</code>
to adopt the cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ bin/hiveutil create-cluster <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--base-domain<span style=color:#ce5c00;font-weight:700>=</span>new-installer.openshift.com kind-cluster1  <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--adopt --adopt-admin-kubeconfig<span style=color:#ce5c00;font-weight:700>=</span>/tmp/cluster1.conf <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--adopt-infra-id<span style=color:#ce5c00;font-weight:700>=</span>fakeinfra <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--adopt-cluster-id<span style=color:#ce5c00;font-weight:700>=</span>fakeid
</span></span></code></pre></div><p>Checking the <code>ClusterDeployment</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ kubectl get clusterdeployment
</span></span><span style=display:flex><span>NAME            PLATFORM   REGION      CLUSTERTYPE   INSTALLED   INFRAID   VERSION   POWERSTATE   AGE
</span></span><span style=display:flex><span>kind-cluster1   aws        us-east-1                 <span style=color:#204a87>true</span>        infra1                           48s
</span></span></code></pre></div><p>Checking the <code>ClusterDeployment</code> status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ kubectl get clusterdeployment kind-cluster1 -o json <span style=color:#000;font-weight:700>|</span> jq .status.conditions
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;lastProbeTime&#34;</span>: <span style=color:#4e9a06>&#34;2021-02-01T14:02:42Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;lastTransitionTime&#34;</span>: <span style=color:#4e9a06>&#34;2021-02-01T14:02:42Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;message&#34;</span>: <span style=color:#4e9a06>&#34;SyncSet apply is successful&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;reason&#34;</span>: <span style=color:#4e9a06>&#34;SyncSetApplySuccess&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;status&#34;</span>: <span style=color:#4e9a06>&#34;False&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;type&#34;</span>: <span style=color:#4e9a06>&#34;SyncSetFailed&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;lastProbeTime&#34;</span>: <span style=color:#4e9a06>&#34;2021-02-01T14:02:41Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;lastTransitionTime&#34;</span>: <span style=color:#4e9a06>&#34;2021-02-01T14:02:41Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;message&#34;</span>: <span style=color:#4e9a06>&#34;cluster is reachable&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;reason&#34;</span>: <span style=color:#4e9a06>&#34;ClusterReachable&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;status&#34;</span>: <span style=color:#4e9a06>&#34;False&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;type&#34;</span>: <span style=color:#4e9a06>&#34;Unreachable&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>]</span>
</span></span></code></pre></div><h2 id=managed-cluster---crc>Managed Cluster - CRC</h2><p>Export the CRC kubeconfig filename to be created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ <span style=color:#204a87>export</span> <span style=color:#000>KUBECONFIG</span><span style=color:#ce5c00;font-weight:700>=</span>/tmp/crc.conf
</span></span></code></pre></div><p>Login to your CRC cluster with the <code>kubeadmin</code> user:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ oc login -u kubeadmin -p **** https://api.crc.testing:6443
</span></span></code></pre></div><p>The <code>/tmp/crc.conf</code> file should now contain the dockerconfig for your
CRC cluster.</p><p>Export the Hive kubeconfig filename and enter the <code>hive</code> directory (or just
switch to the first terminal, the one used to deploy Hive):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ <span style=color:#204a87>export</span> <span style=color:#000>KUBECONFIG</span><span style=color:#ce5c00;font-weight:700>=</span>/tmp/hive.conf
</span></span><span style=display:flex><span>~$ <span style=color:#204a87>cd</span> hive
</span></span></code></pre></div><p>Because Hive will not provision that cluster, we have can use the <code>hiveutil</code>
to adopt it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ bin/hiveutil create-cluster <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--base-domain<span style=color:#ce5c00;font-weight:700>=</span>crc.openshift.com crc  <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--adopt --adopt-admin-kubeconfig<span style=color:#ce5c00;font-weight:700>=</span>/tmp/crc.conf <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--adopt-infra-id<span style=color:#ce5c00;font-weight:700>=</span>fakeinfra <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--adopt-cluster-id<span style=color:#ce5c00;font-weight:700>=</span>fakeid
</span></span></code></pre></div><p>Checking the <code>ClusterDeployment</code> status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ kubectl get clusterdeployment crc -o json <span style=color:#000;font-weight:700>|</span> jq .status.conditions
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;lastProbeTime&#34;</span>: <span style=color:#4e9a06>&#34;2021-02-02T14:21:02Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;lastTransitionTime&#34;</span>: <span style=color:#4e9a06>&#34;2021-02-02T14:21:02Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;message&#34;</span>: <span style=color:#4e9a06>&#34;cluster is reachable&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;reason&#34;</span>: <span style=color:#4e9a06>&#34;ClusterReachable&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;status&#34;</span>: <span style=color:#4e9a06>&#34;False&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;type&#34;</span>: <span style=color:#4e9a06>&#34;Unreachable&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;lastProbeTime&#34;</span>: <span style=color:#4e9a06>&#34;2021-02-02T01:45:19Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;lastTransitionTime&#34;</span>: <span style=color:#4e9a06>&#34;2021-02-02T01:45:19Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;message&#34;</span>: <span style=color:#4e9a06>&#34;SyncSet apply is successful&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;reason&#34;</span>: <span style=color:#4e9a06>&#34;SyncSetApplySuccess&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;status&#34;</span>: <span style=color:#4e9a06>&#34;False&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;type&#34;</span>: <span style=color:#4e9a06>&#34;SyncSetFailed&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>]</span>
</span></span></code></pre></div><p>Tip: in case the cluster status is &ldquo;unreachable&rdquo;, that&rsquo;s because Hive runs
in a Kubernetes cluster deployed inside a container, and it is trying to access
the CRC virtual machine that is controlled by libvirt. You will have to figure
out you firewall, but this is what worked for me:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ firewall-cmd --permanent --zone<span style=color:#ce5c00;font-weight:700>=</span>trusted --change-interface<span style=color:#ce5c00;font-weight:700>=</span>docker0
</span></span><span style=display:flex><span>success
</span></span><span style=display:flex><span>~/hive$ firewall-cmd --reload
</span></span><span style=display:flex><span>success
</span></span></code></pre></div><h2 id=selectorsyncset>SelectorSyncSet</h2><p>Export the Hive kubeconfig:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ <span style=color:#204a87>export</span> <span style=color:#000>KUBECONFIG</span><span style=color:#ce5c00;font-weight:700>=</span>/tmp/hive.conf
</span></span></code></pre></div><p>Create a test <code>SelectorSyncSet</code>. Example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>List</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>items</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hive.openshift.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SelectorSyncSet</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cso-test</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>clusterDeploymentSelector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>api.openshift.com/cso-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;true&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resourceApplyMode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Sync</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Namespace</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cso</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Apply it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ kubectl apply -f cso-test.yaml
</span></span><span style=display:flex><span>selectorsyncset.hive.openshift.io/cso-test created
</span></span></code></pre></div><p>Now edit the <code>ClusterDeployment</code> of a cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ kubectl edit clusterdeployment kind-cluster1
</span></span></code></pre></div><p>Adding the label <code>api.openshift.com/cso-test: 'true'</code> to it. Save and exit.</p><p>The <code>cso</code> namespace should be now created in the target cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>export</span> <span style=color:#000>KUBECONFIG</span><span style=color:#ce5c00;font-weight:700>=</span>/tmp/cluster1.conf
</span></span><span style=display:flex><span>$ oc get namespace cso
</span></span><span style=display:flex><span>NAME   STATUS   AGE
</span></span><span style=display:flex><span>cso    Active   81s
</span></span></code></pre></div><h2 id=cleanup>Cleanup</h2><p>To clean-up, delete the two clusters and surrounding clutter:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/hive$ kind delete cluster --name hive
</span></span><span style=display:flex><span>~/hive$ kind delete cluster --name cluster1
</span></span><span style=display:flex><span>~/hive$ docker rm -f kind-registry
</span></span><span style=display:flex><span>~/hive$ docker network rm kind
</span></span></code></pre></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.3bff53fa2e8d9a2c4d0b3eeea5987ff2f2cc9a0f4eccb730274827d5e7cd5538.js integrity="sha256-O/9T+i6NmixNCz7upZh/8vLMmg9OzLcwJ0gn1efNVTg=" crossorigin=anonymous></script></body></html>