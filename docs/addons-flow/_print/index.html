<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.115.3"><link rel=canonical type=text/html href=/docs/addons-flow/><link rel=alternate type=application/rss+xml href=/docs/addons-flow/index.xml><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/favicons/android-chrome-512x512.png sizes=512x512><title>Addons Flow | Layered Products SRE</title><meta name=description content="Addons Flow.
"><meta property="og:title" content="Addons Flow"><meta property="og:description" content="Addons Flow.
"><meta property="og:type" content="website"><meta property="og:url" content="/docs/addons-flow/"><meta itemprop=name content="Addons Flow"><meta itemprop=description content="Addons Flow.
"><meta name=twitter:card content="summary"><meta name=twitter:title content="Addons Flow"><meta name=twitter:description content="Addons Flow.
"><link rel=preload href=/scss/main.min.0799d219d5950ac36000bb078e915525f0e42b82cd2a4e21fbeb9a6015fc5ef0.css as=style><link href=/scss/main.min.0799d219d5950ac36000bb078e915525f0e42b82cd2a4e21fbeb9a6015fc5ef0.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo></span><span class=font-weight-bold>Layered Products SRE</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/internal-documentation/access/><span>Getting Access</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.9d5355696b6fca5b7d4a71985b0d8b71.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/addons-flow/>Return to the regular view of this page</a>.</p></div><h1 class=title>Addons Flow</h1><div class=lead>Addons Flow.</div><ul><li>1: <a href=#pg-3c27fb28a51f6a704949207f178f4dcb>Addons Flow Architecture</a></li><li>2: <a href=#pg-b1cd195b3541e3385edeeb4336a5bbc5>APIs</a></li><li>3: <a href=#pg-e696ffe273b48e557d5a384c806c48da>Metrics</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-3c27fb28a51f6a704949207f178f4dcb>1 - Addons Flow Architecture</h1><p>Add-Ons are Operators. As such, Add-Ons are installed using typical Operator
objects, like <code>Subscription</code>, <code>OperatorGroup</code> and <code>CatalogSource</code>.</p><p>To get those objects into the OpenShift clusters, we rely on
<a href=https://cloud.redhat.com/openshift/>OCM</a> and
<a href=https://github.com/openshift/hive>Hive</a>. You can read more
about Hive in this <a href=https://cloud.redhat.com/blog/openshift-hive-cluster-as-a-service>blog post</a>.</p><h2 id=deployment>Deployment</h2><p>Our input is the Add-On metadata file
(<code>managed-tenants/addons/&lt;addon_name>/metadata/&lt;stage|prod>/addon.yaml</code>)
and the corresponding bundles directories
(<code>managed-tenants-bundles/addons/&lt;addon_name>/</code>).
With that in place, we will:</p><ul><li>Build the Operator catalog container image.<ul><li>Push the catalog image to our organization repository in Quay.io.</li></ul></li><li>Generate a
<a href=https://github.com/openshift/hive/blob/master/docs/syncset.md#syncset-object-definition>SyncSet</a>
with the Operator install objects.<ul><li>Apply the SyncSet to Hive.</li></ul></li><li>Generate the OCM API payload.<ul><li>Post the payload to OCM.</li></ul></li></ul><p>The Managed Tenants CI is in charge of processing the input and deploying all
the artifacts. This image shows the data flows:</p><p><img src=/addon-syncset-installation.png alt="Data Flows"></p><p>With that in place, OCM will present an &ldquo;Add-Ons&rdquo; tab, listing all the Add-Ons
that your organization has quota for. Example:</p><p><img src=/architecture_ocm_ui.png alt="Data Flows"></p><h2 id=installation>Installation</h2><p>When you click &ldquo;Install&rdquo; in the OCM Web UI, under the hood, OCM creates a
<code>SyncSet</code> <a href=https://github.com/openshift/hive/blob/master/docs/syncset.md#syncset-object-definition>object</a>
in Hive. The <code>SyncSet</code> object references the cluster in which the addon was just
installed in the <code>clusterDeploymentRefs</code> field.</p><p><img src=/architecture_install_flow.png alt="Data Flows">
<a href="https://excalidraw.com/#room=71d4b0273d4404dbbebf,Pk5KFYj9fFvXSvObY6juCA">excalidraw</a></p><p>From there, OLM will take over, installing the Operator in the OpenShift
cluster. While OLM is installing the Operator, OCM will keep polling the
telemetry data reported by the cluster, waiting for the <code>csv_succeeded=1</code>
metric from that Operator:</p><p><img src=/architecture_telemetry_wait.png alt="Data Flows"></p><p>At some point, when the Operator is fully installed, OCM will reflect that in
the Web UI:</p><p><img src=/architecture_telemetry_done.png alt="Data Flows"></p><h2 id=addon-status-lifecycle>Addon Status Lifecycle</h2><p><img src=/addon-status-ocm.png alt="Addon Status Lifecycle"></p><h2 id=deprecated-selectorsyncset-installation>Deprecated SelectorSyncSet Installation</h2><p><img src=/architecture_data_flow.png alt="Data Flows">
When you click &ldquo;Install&rdquo; in the OCM Web UI, under the hood, OCM will apply
a label to the corresponding <code>ClusterDeployment</code> object in Hive.</p><p>That label is the same label used in the <code>SelectorSyncSet</code> as a <code>matchLabel</code>.</p><p>With the <code>ClusterDeployment</code> label now matching the <code>SelectorSyncSet</code> label,
Hive will apply all the objects in the <code>SelectorSyncSet</code> to the target cluster:</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b1cd195b3541e3385edeeb4336a5bbc5>2 - APIs</h1><p>You can find the Addons APIs <a href=https://api.openshift.com/#/default>here</a> under
the paths <code>/api/clusters_mgmt/v1/addons/{addon_id}</code>,
<code>/api/clusters_mgmt/v1/clusters/{cluster_id}/addon_inquiries</code> and
<code>/api/clusters_mgmt/v1/clusters/{cluster_id}/addons/{addoninstallation_id}</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e696ffe273b48e557d5a384c806c48da>3 - Metrics</h1><h2 id=addon-operator-metrics>Addon Operator Metrics</h2><p>Addon operator metrics can be found in <a href=https://promlens.devshift.net/>PromLens</a>
in the <code>osd-observatorum-production</code> datasource.</p><p>The metrics are configured in the <a href=https://gitlab.cee.redhat.com/service/lifecycler/>lifecycler repo</a>
and the <a href=https://github.com/openshift/managed-cluster-config>managed-cluster-config repo</a>.
See the following two merge requests for reference: <a href=https://gitlab.cee.redhat.com/service/lifecycler/-/merge_requests/6/diffs>lifecycler MR</a>
and <a href=https://github.com/openshift/managed-cluster-config/pull/1281/files>managed-cluster-config MR</a>.</p><h2 id=csv_succeeded-and-csv_abnormal-metrics><code>csv_succeeded</code> and <code>csv_abnormal</code> Metrics</h2><p><code>csv_succeeded</code> and <code>csv_abnormal</code> Metrics can be found in <a href=https://infogw-proxy.api.openshift.com/>production Thanos</a>
and <a href=https://infogw-proxy.api.stage.openshift.com/>stage Thanos</a>.</p><p>It can be useful to query for <code>csv_succeeded</code> and <code>csv_abnormal</code> Metrics
by operator name, for example <code>csv_succeeded{name=~"ocs-operator.*"}</code>, or
by cluster id, for example <code>csv_succeeded{_id="049ea229-55dd-4e30-a2f0-87ae1dd37de6"}</code>.</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.3bff53fa2e8d9a2c4d0b3eeea5987ff2f2cc9a0f4eccb730274827d5e7cd5538.js integrity="sha256-O/9T+i6NmixNCz7upZh/8vLMmg9OzLcwJ0gn1efNVTg=" crossorigin=anonymous></script></body></html>